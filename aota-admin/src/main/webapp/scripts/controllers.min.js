/*! aota */
"use strict";angular.module("aotaApp.controllers",[]).run(["$rootScope",function($rootScope){$rootScope.activeLi=function(){$(".navbar-main li.active").removeClass("active");var elem=$("."+$rootScope.path);movePointerTo(elem),activeElem(elem)}}]).controller("DashboardCtrl",["$scope","$location","$rootScope","stcStatService",function($scope,$location,$rootScope,Dashboard){$rootScope.title="Dashboard",$rootScope.header="Dashboard Chart",$rootScope.path="dashboard",$rootScope.activeLi(),loadStyle(HOST+"styles/dashboard.min.css"),loadScript(HOST+"bower_components/chart-js/Chart.min.js");var options={animation:!1,scaleFontSize:10,tooltipFontSize:12,tooltipCornerRadius:2,scaleLineColor:"rgba(0,0,0,.06)",scaleShowGridLines:!1,bezierCurve:!1,pointDotStrokeWidth:2,gradientFill:!0};isChrome()&&$.extend(options,{animation:!0});var darkerOptions=$.extend({},options,{darkerLine:!0});$scope.total=[0,0,0,0];var ddCtx=$("#d-d")[0].getContext("2d"),udCtx=$("#u-d")[0].getContext("2d"),dwCtx=$("#d-w")[0].getContext("2d"),uwCtx=$("#u-w")[0].getContext("2d");Dashboard.query().$promise.then(function(data){var ddData=convertChartData(data.data.dd,1,1),dwData=convertChartData(data.data.dw,1,7),udData=convertChartData(data.data.ud,2,1),uwData=convertChartData(data.data.uw,2,7);$scope.total=[getArrSum(data.data.dd),getArrSum(data.data.ud),getArrSum(data.data.dw),getArrSum(data.data.uw)];new Chart(ddCtx).Line(ddData.data,options),new Chart(udCtx).Line(udData.data,options),new Chart(dwCtx).Line(dwData.data,darkerOptions),new Chart(uwCtx).Line(uwData.data,darkerOptions)})}]).controller("StatistCtrl",["$scope","$rootScope","dynStatService","updateSqcService",function($scope,$rootScope,DynStat,AppSqc){$rootScope.title="Statist",$rootScope.header="Search",$rootScope.path="statist",$rootScope.activeLi(),loadStyle(HOST+"styles/statist.min.css"),loadScript(HOST+"bower_components/chart-js/Chart.min.js"),$(window).resize(function(){resizeTable(230)}),$scope.queryParams={type:1,day:1,percent:$scope.percent||100},$scope.orderProp="appSequence";var firstSearch=!$(".chart-container").hasClass("show"),statDayCtx=$("#stat-chart-day")[0].getContext("2d"),statWeekCtx=$("#stat-chart-week")[0].getContext("2d"),statDayChart=null,statWeekChart=null;$scope.queryDynStat=function(){DynStat.query($scope.queryParams).$promise.then(function(data){function updateChart(){$scope.chartType=1===type?"Download":"Upgrade",$scope.chartIcon=chartData.icon,$scope.chartTotal=getArrSum(chartData.data.datasets[0].data),$scope.totalColor=chartData.totalColor,$scope.$digest(),1===day?($("#stat-chart-week").removeClass("show"),$("#stat-chart-day").addClass("show"),statDayChart=new Chart(statDayCtx).Line(chartData.data,chartData.options)):7===day&&($("#stat-chart-week").addClass("show"),$("#stat-chart-day").removeClass("show"),statWeekChart=new Chart(statWeekCtx).Line(chartData.data,chartData.options))}resizeTable(240);var type=$scope.queryParams.type,day=$scope.queryParams.day,chartData=convertChartData(data.data[0],type,day);firstSearch?$(".chart-container").animate({height:"195px"},"normal","swing",function(){updateChart()}):updateChart(),$scope.apps=data.data[1]})},$scope.updateSqc=function(event){var elem=event.currentTarget,appId=+$(elem).attr("data-id"),sequence=+$(elem).val(),saveParams={appId:appId,sequence:sequence};AppSqc.save(saveParams).$promise.then(function(data){if(0!==data.status)for(var i=0;i<$scope.apps.length;i++)$scope.apps[i].id===appId&&($scope.apps[i].appSequence=sequence);else alert("Update app sequence failed!")})}}]).controller("AppManageCtrl",["$scope","$http","$rootScope","updateSqcService","appService","ruleService",function($scope,$http,$rootScope,AppSqc,App,Rule){function removeAppFromScope(ids){var toDelete=[],indexOffset=0;$.each($scope.apps,function(index){-1!==$.inArray(this.id,ids)&&toDelete.push(index)});for(var i=0;i<toDelete.length;i++)$scope.apps.splice(toDelete[i]-indexOffset,1),indexOffset++}$rootScope.title="App Management",$rootScope.header="Search",$rootScope.path="app_management",$rootScope.activeLi(),loadStyle(HOST+"styles/app-manage.min.css");var appSs1=null,appSs2=null,appSs3=null,appSs4=null;$(window).resize(function(){resizeTable(100)}),$("#upload-app-btn").click(function(){$scope.newApp={appName:null,apkPackName:null,appSize:null,appStartGrade:null,appDeveloper:null,appDetail:null,appPermission:null,appIconUUID:null,appImgUUIDs:null,sourceChannel:1,versionName:null,versionCode:null,appUrlUUID:null},appSs1=null,appSs2=null,appSs3=null,appSs4=null,$scope.$digest(),$("#save-app").attr("disabled",!1).html("OK"),$("#upload-apk").attr("disabled",!1).html("Upload"),$("#upload-app form")[0].reset(),$(".upload-area img").hide(),$("#upload-app").modal("show"),$(".modal-body-cover").hide()}),$(".upload-area").click(function(){$(this).find("input[type=file]").click()}),$(".upload-area input[type=file]").click(function(e){e.stopPropagation()}),$("#choose-apk").click(function(){$("#apk").click()}),$("#apk").change(function(){var file=this.files[0];return"apk"!==getSuffix(file.name)?(alert("Please choose an apk file to upload"),!1):($("#apk-url").val(file.name),void $("#upload-apk").attr("disabled",!1).html("Upload"))}),$("#upload-apk").click(function(){var file=$("#apk")[0].files[0];file?uploadFile({file:file,useFormData:!0,fileName:"apkFile",url:HOST+"app/res/parseApk",onProgress:function(file,loaded,total){$("#upload-apk").attr("disabled",!0).html(Math.round(loaded/total*100)+"%")},onSuccess:function(file,response){$("#upload-apk").html('<i class="fa fa-check"></i>');var data=JSON.parse(response);1===data.status&&(2===data.data.resultFlag?($scope.newApp.appUrlUUID=data.data.apkuuid,$scope.newApp.appName=data.data.appName,$scope.newApp.appSize=data.data.fileSize+"",$scope.newApp.apkPackName=data.data.packageName,$scope.newApp.appPermission=data.data.permissions,$scope.newApp.versionCode=data.data.versionCode,$scope.newApp.versionName=data.data.versionName,$scope.$digest()):alert(1===data.data.resultFlag?"Apk parse failed":"Apk upload failed"))},onFailure:function(){alert("Parse file failed"),$("#upload-apk").attr("disabled",!1).html("Upload")},onComplete:function(){$("#apk")[0].files=[]}}):alert("Please choose an apk first")}),$("#app-icon").change(function(){var file=this.files[0];return isImage(file.name)?(imageReader(file,function(result){$("#app-icon-preview").attr("src",result).fadeIn()}),void uploadFile({file:file,useFormData:!0,fileName:$(this).attr("id"),url:HOST+"app/res/upload",onProgress:function(){},onSuccess:function(file,response){var data=JSON.parse(response);1===data.status&&("success"===data.data[0].result?$scope.newApp.appIconUUID=data.data[0].fileUuid:alert("Image upload failed"))},onFailure:function(){alert("Parse file failed")},onComplete:function(){}})):(alert("Please choose jpg/png/gif to upload"),!1)}),$(".app-ss").change(function(){var self=this,file=this.files[0];return isImage(file.name)?(imageReader(file,function(result){$(self).parent().find(".app-ss-preview").attr("src",result).fadeIn()}),void uploadFile({file:file,useFormData:!0,fileName:$(this).attr("id"),url:HOST+"app/res/upload",onProgress:function(){},onSuccess:function(file,response){var data=JSON.parse(response);1===data.status&&("success"===data.data[0].result?"app-ss-1"===$(self).attr("id")?appSs1=data.data[0].fileUuid:"app-ss-2"===$(self).attr("id")?appSs2=data.data[0].fileUuid:"app-ss-3"===$(self).attr("id")?appSs3=data.data[0].fileUuid:"app-ss-4"===$(self).attr("id")&&(appSs4=data.data[0].fileUuid):alert("Image upload failed"))},onFailure:function(){alert("Parse file failed")},onComplete:function(){}})):(alert("Please choose jpg/png/gif to upload"),!1)}),$scope.addApp=function(){for(var ssArr=[appSs1,appSs2,appSs3,appSs4],appSs=[],i=0;i<ssArr.length;i++)ssArr[i]&&appSs.push(ssArr[i]);$scope.newApp.appImgUUIDs=appSs.join(",");for(var a in $scope.newApp)if(log($scope.newApp[a]),!$.trim($scope.newApp[a]))return alert("All infomations needed, please check again"),!1;$("#save-app").html("Uploading...").attr("disabled",!0),$(".modal-body-cover").show(),App.save($scope.newApp).$promise.then(function(data){1===data.status?(alert("Upload Success"),$("#upload-app").modal("hide")):(alert("App upload failed"),$(".modal-body-cover").hide())})},$scope.queryParams={appName:$scope.appName,sourceChannel:$scope.sourceChannel,appSequence:$scope.appSequence,versionName:$scope.versionName,appDeveloper:$scope.appDeveloper,uploadTime:$scope.uploadTime,trash:0},$scope.orderProp="appSequence",$scope.queryApp=function(){$http.post(HOST+"app/res/list/1",$scope.queryParams).success(function(data){0!==data.status&&(resizeTable(100),$scope.apps=data.data.appList)})},$scope.updateSqc=function(event){var elem=event.currentTarget,appId=+$(elem).attr("data-id"),sequence=+$(elem).val(),saveParams={appId:appId,sequence:sequence};AppSqc.save(saveParams).$promise.then(function(data){if(0!==data.status)for(var i=0;i<$scope.apps.length;i++)$scope.apps[i].id===appId&&($scope.apps[i].appSequence=sequence);else alert("Update app sequence failed!")})},$scope.rule={id:1,upgradePeriod:null,autoDownwifi:null,delUpgradeapk:null,clearCache:null},$("#upgrade-rule-btn").click(function(){Rule.query().$promise.then(function(data){$scope.rule=data.data}),$("#upgrade-rule").modal("show")}),$scope.saveRule=function(){Rule.save($scope.rule).$promise.then(function(data){1===data.status?$("#upgrade-rule").modal("hide"):alert("Rule upgrade failed")})},$scope.deleteApp=function(){var ids=getTableCheckedId($(".tbody table"));return ids.length?void(confirm("Do you really want to delete choosen apps?")&&App.remove(ids).$promise.then(function(data){0!==data.status&&removeAppFromScope(ids)})):void alert("Please choose app to delete")},$scope.pkgApp=function(){var ids=getTableCheckedId($(".tbody table"));return ids.length?void App.pkg(ids).$promise.then(function(data){0!==data.status&&(alert("package generated"),removeAppFromScope(ids))}):void alert("Please choose app to make package")}}]).controller("PkgManageCtrl",["$scope","$http","$rootScope","updateSqcService",function($scope,$http,$rootScope){$rootScope.title="Package Management",$rootScope.header="Search",$rootScope.path="package_management",$rootScope.activeLi(),$(window).resize(function(){resizeTable(100)}),$scope.queryParams={packageName:$scope.packageName,createTime:$scope.createTime,quantity:$scope.quantity,sequence:$scope.sequence},$scope.queryPkg=function(){$http.post(HOST+"/package",$scope.queryParams).success(function(data){0!==data.status&&(resizeTable(100),$scope.pkgs=data.data)})},$scope.releasePkg=function(){var ids=getTableCheckedId();if(1!=ids.length)return void alert("Please select one release");var id=ids[0];$http.put(HOST+"/package/release/"+ids[0]).success(function(data){$.each($scope.pkgs,function(idx,item){return item.id==id?(item.releaseTime=data.status,!1):void 0})})},$scope.dissolutionPkg=function(){var ids=getTableCheckedId();$http.post(HOST+"/package/dismiss",ids).success(function(data){data.status>0&&(alert("Dissolution Package Success"),$scope.queryPkg())})}}]).controller("RecycleBinCtrl",["$scope","$http","$rootScope","updateSqcService",function($scope,$http,$rootScope){$rootScope.title="Recycle Bin",$rootScope.header="Search",$rootScope.path="recycle_bin",$rootScope.activeLi(),$(window).resize(function(){resizeTable(100)}),$scope.orderProp="appSequence",$scope.queryParams={appName:$scope.appName,sourceChannel:$scope.sourceChannel,appSequence:$scope.appSequence,versionName:$scope.versionName,appDeveloper:$scope.appDeveloper,uploadTime:$scope.uploadTime,trash:1},$scope.queryApp=function(){$http.post(HOST+"app/res/list/1",$scope.queryParams).success(function(data){0!==data.status&&(resizeTable(100),$scope.apps=data.data.appList)})},$scope.doRecovery=function(){var ids=getTableCheckedId();ids.length&&$http.post(HOST+"/app/recycle/recovery",ids).success(function(data){0!==data.status&&(alert("Recovery Success"),$scope.queryApp())})},$scope.doDelete=function(){var ids=getTableCheckedId();ids.length&&confirm("Do you really want to delete choosen apps thoroughly?\r(this operation cannot be undone)")&&$http.post(HOST+"/app/recycle/remove",ids).success(function(data){0!==data.status&&$scope.queryApp()})}}]);